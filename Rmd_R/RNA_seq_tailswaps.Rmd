# -----------------------------------------------
# Script for RNA-seq in Tailswap Strains (Figure 5C, 5D)
# Author: [Jian Yi Kok]
# Date: [2025-07-17]
# Description: This script analyzes RNA-seq data from CHD1 tailswap strains.
# -----------------------------------------------

```{r}
# -----------------------------------------------
# Figure 5C
# -----------------------------------------------

# Load required libraries
library(readxl)
library(dplyr)
library(tximport)
library(reshape2)
library(ggplot2)
library(ggpointdensity)
library(viridis)

# Define paths
kallisto_path <- "/path/to/kallisto_counts"  # Replace with actual path
metadata_file <- "/path/to/metadata.xlsx"  # Replace with actual path
output_dir <- "/path/to/output/plots/"  # Replace with desired output directory

# Define filtering thresholds
min_reads <- 15


# Read metadata
metadata <- read_excel(metadata_file)
colnames(metadata) <- c("SampleID", "Genotype", "Replicate")

# Create experimental design
data_set <- metadata %>%
  dplyr::mutate(Genotype = factor(Genotype, levels = unique(Genotype))) %>%
  dplyr::select(SampleID, Genotype, Replicate)
rownames(data_set) <- data_set$SampleID

# List all sample directories
paired_kallisto_directories <- list.dirs(kallisto_path, recursive = FALSE)
sample_names <- data_set$SampleID
full <- file.path(paired_kallisto_directories, "paired", "abundance.h5")
names(full) <- sample_names

# Read transcript-level counts
transcript_counts <- tximport(full, type = "kallisto", tx2gene = NULL, txOut = TRUE)
transcript_counts <- transcript_counts$counts

# Filter transcripts with fewer than the minimum number of reads
transcript_counts <- transcript_counts[rowSums(transcript_counts) > min_reads, ]
ids <- rownames(transcript_counts)

# Create tx2gene table for gene-level analysis
tx2gene <- data.frame(tx_id = ids, gene_id = ids)
tx2gene$gene_id <- gsub("transcript:", "", tx2gene$gene_id)  # Remove "transcript:" prefix
tx2gene$gene_id <- gsub("\\.[0-9]+$", "", tx2gene$gene_id)  # Remove version numbers

# Summarize to gene-level counts
txi <- tximport(full, type = "kallisto", tx2gene = tx2gene)

# -----------------------------------------------
# DESeq2 Analysis
# -----------------------------------------------

# Create DESeq2 dataset
dds <- DESeqDataSetFromTximport(txi, data_set, ~ Genotype)

# Apply VST normalization
vst <- vst(dds)
counts <- assay(vst)

# Average normalized counts by genotype
colnames(counts) <- metadata$Genotype
nms <- unique(colnames(counts))
ncounts.avg <- sapply(nms, function(x) rowMeans(counts[, colnames(counts) %in% x, drop = FALSE]))
colnames(ncounts.avg) <- c("WT", "hrp1", "hrp3", "hrp1hrp3", "hrp1tohrp3Cter", "hrp3tohrp1Cter")

# Split into sense and antisense
ncounts.avg.sense <- ncounts.avg[!grepl("^G", rownames(ncounts.avg)), ]
ncounts.avg.antisense <- ncounts.avg[grepl("^G", rownames(ncounts.avg)), ]

# -----------------------------------------------
# Boxplot for Antisense Transcription
# -----------------------------------------------

# Reshape antisense data for plotting
ncounts.avg.antisense.long <- melt(ncounts.avg.antisense, variable.name = "Mutant", value.name = "Value")
colnames(ncounts.avg.antisense.long) <- c("Gene", "Mutant", "Value")

# Define colors for the plot
colors <- c(
  "WT" = "#D3D3D3", "hrp1" = "#0072B2", "hrp3" = "#CC79A7",
  "hrp1hrp3" = "#E69F00", "hrp3tohrp1Cter" = "#00AEEF", "hrp1tohrp3Cter" = "#9E1F63"
)

# Create boxplot
p1 <- ggplot(ncounts.avg.antisense.long, aes(x = Mutant, y = Value, fill = Mutant)) +
  geom_hline(yintercept = median(as.data.frame(ncounts.avg.antisense)$WT), linetype = "dotted", color = "black") +
  geom_boxplot(outlier.shape = NA) +
  scale_fill_manual(values = colors) +
  theme_minimal() +
  ylim(8.5, 10.5) +
  labs(
    title = "Boxplot of Each Mutant",
    x = "Mutant",
    y = "Antisense Expression (Normalized Counts)"
  ) +
  theme(
    panel.border = element_rect(fill = NA, colour = "black", size = 1),
    panel.grid.minor = element_blank(),
    axis.ticks = element_line(color = "black", linewidth = 0.5),
    axis.ticks.length = unit(0.4, "cm"),
    text = element_text(size = 15)
  )

# Save the boxplot
output_file <- file.path(output_dir, "p1.pdf")
ggsave(output_file, plot = p1, width = 5, height = 3.5)
```


```{r}
# -----------------------------------------------
# Figure 5D
# -----------------------------------------------

# Define strains and labels
strains <- c("hrp1", "hrp3", "hrp1hrp3", "hrp1tohrp3Cter", "hrp3tohrp1Cter")
y_labels <- strains

# Create scatter plots for sense transcription
plot_list_s <- lapply(seq_along(strains), function(i) {
  subset_data <- ncounts.avg.sense[, c("WT", strains[i])]
  colnames(subset_data) <- c("WT_sense", "Strain_sense")
  ggplot(subset_data, aes(x = WT_sense, y = Strain_sense)) +
    geom_pointdensity() +
    scale_color_viridis() +
    geom_abline(intercept = 0, slope = 1, color = "red", linewidth = 1) +
    labs(x = "WT Sense Transcription", y = y_labels[i], color = "Gene density") +
    theme_minimal() +
    xlim(7, 18) + ylim(7, 18) +
    theme(text = element_text(size = 20))
})

# Save sense scatter plots
for (i in seq_along(plot_list_s)) {
  output_file <- file.path(output_dir, paste0("sense_scatter_", strains[i], ".tiff"))
  ggsave(output_file, plot = plot_list_s[[i]], width = 6, height = 3.5)
}

# Create scatter plots for antisense transcription
plot_list_as <- lapply(seq_along(strains), function(i) {
  subset_data <- ncounts.avg.antisense[, c("WT", strains[i])]
  colnames(subset_data) <- c("WT_antisense", "Strain_antisense")
  ggplot(subset_data, aes(x = WT_antisense, y = Strain_antisense)) +
    geom_pointdensity() +
    scale_color_viridis() +
    geom_abline(intercept = 0, slope = 1, color = "red", linewidth = 1) +
    labs(x = "WT Antisense Transcription", y = y_labels[i], color = "Gene density") +
    theme_minimal() +
    xlim(8.5, 10.5) + ylim(8.5, 10.5) +
    theme(text = element_text(size = 20))
})

# Save antisense scatter plots
for (i in seq_along(plot_list_as)) {
  output_file <- file.path(output_dir, paste0("antisense_scatter_", strains[i], ".tiff"))
  ggsave(output_file, plot = plot_list_as[[i]], width = 6, height = 3.5)
}

# -----------------------------------------------
# Completion
# -----------------------------------------------

cat("Plots saved successfully to:", output_dir, "\n")
```

